<template>
  <v-dialog
    v-model="dialog"
    @update:modelValue="(val:boolean) => closeDialog(val)"
    :scrim="false"
    transition="dialog-bottom-transition"
    hide-overlay
  >
    <v-toolbar color="primary">
      <div class="d-flex justify-center">
        <v-btn icon dark @click="() => $emit('close-dialog', false)">
          <v-icon>mdi-close</v-icon>
        </v-btn>
      </div>
    </v-toolbar>
    <template v-if="loading">
      <v-card class="d-flex justify-center align-center h-screen">
        <div class="d-flex my-6 align-center justify-center">
          <v-progress-circular />
        </div>
        <p>Loading node details...</p>
      </v-card>
    </template>
    <template v-else-if="isError">
      <v-card class="d-flex justify-center align-center h-screen">
        <div class="text-center w-100 pa-3">
          <v-icon variant="tonal" color="error" style="font-size: 50px" icon="mdi-close-circle-outline" />
          <p class="mt-4 mb-4 font-weight-bold text-error">
            {{ errorMessage }}
          </p>
          <v-btn class="mr-4" @click="requestNode" color="primary" text="Try Again" />
          <v-btn @click="(val:boolean) => closeDialog(val)" color="error" variant="outlined" text="Cancel" />
        </div>
      </v-card>
    </template>

    <template v-else>
      <v-card>
        <node-resources-charts :node="node" :is-live-stats="isLiveStats" :hint-message="errorLoadingStatsMessage" />
        <v-row class="pa-8 mt-5" justify-md="start" justify-sm="center">
          <v-col cols="12" md="6" sm="8">
            <node-details-card :node="node" />
          </v-col>
          <v-col cols="12" md="6" sm="8">
            <country-details-card :node="node" />
            <location-details-card class="mt-5" :node="node" />
          </v-col>
          <v-col cols="12" md="6" sm="8">
            <farm-details-card :node="node" />
          </v-col>
          <v-col cols="12" md="6" sm="8">
            <twin-details-card :node="node" />
          </v-col>
          <v-col cols="12" md="6" sm="8">
            <interfaces-details-card :node="node" />
          </v-col>
          <v-col v-if="node.cards?.length || node.num_gpu > 0" cols="12" md="6" sm="8">
            <gpu-details-card :node="node" :nodeOptions="nodeOptions" />
          </v-col>
          <v-col v-if="node.publicConfig && node.publicConfig.domain" cols="12" md="6" sm="8">
            <public-config-details-card :node="node" />
          </v-col>

          <v-col v-if="hasActiveProfile && node.healthy" cols="12" md="6" sm="8">
            <i-perf-card :node="node" />
          </v-col>
          <v-col v-if="hasActiveProfile && node.healthy" cols="12" md="6" sm="8">
            <cpu-benchmark-card :node="node" />
          </v-col>
        </v-row>
      </v-card>
    </template>
  </v-dialog>
</template>

<script lang="ts">
import { type GridNode, NodeStatus } from "@threefold/gridproxy_client";
import { type PropType, ref, watch } from "vue";
import { computed } from "vue";
import { useRoute } from "vue-router";

import CountryDetailsCard from "@/components/node_details_cards/country_details_card.vue";
import cpuBenchmarkCard from "@/components/node_details_cards/cpu_benchmark_card.vue";
import FarmDetailsCard from "@/components/node_details_cards/farm_details_card.vue";
import GpuDetailsCard from "@/components/node_details_cards/gpu_details_card.vue";
import InterfacesDetailsCard from "@/components/node_details_cards/interfaces_details_card.vue";
import LocationDetailsCard from "@/components/node_details_cards/location_details_card.vue";
import NodeDetailsCard from "@/components/node_details_cards/node_details_card.vue";
import PublicConfigDetailsCard from "@/components/node_details_cards/public_config_details_card.vue";
import TwinDetailsCard from "@/components/node_details_cards/twin_details_card.vue";
import router from "@/router";
import { useProfileManager } from "@/stores";
import type { FilterOptions } from "@/types";
import { type GridProxyRequestConfig, nodeInitializer } from "@/types";
import { getNode, getNodeStatusColor } from "@/utils/get_nodes";

import IPerfCard from "./node_details_cards/iperf_details_card.vue";
import NodeResourcesCharts from "./node_resources_charts.vue";
export default {
  props: {
    openDialog: {
      type: Boolean,
      required: true,
    },
    nodeId: {
      type: Number,
      required: true,
    },
    filterOptions: {
      type: Object as PropType<FilterOptions>,
      required: true,
    },
  },

  components: {
    NodeResourcesCharts,
    NodeDetailsCard,
    FarmDetailsCard,
    CountryDetailsCard,
    LocationDetailsCard,
    InterfacesDetailsCard,
    TwinDetailsCard,
    GpuDetailsCard,
    PublicConfigDetailsCard,
    IPerfCard,
    cpuBenchmarkCard,
  },

  setup(props, { emit }) {
    const loading = ref<boolean>(false);
    const dialog = ref<boolean>(false);
    const isError = ref<boolean>(false);
    const isLiveStats = ref<boolean>(false);

    const errorLoadingStatsMessage = ref<string>();
    const errorMessage = ref<string>("");
    const route = useRoute();
    const profileManager = useProfileManager();
    const hasActiveProfile = computed(() => {
      return !!profileManager.profile;
    });
    const node = ref<GridNode>(nodeInitializer);

    const nodeOptions: GridProxyRequestConfig = {
      loadTwin: true,
      loadFarm: true,
      loadStats: true,
      loadGpu: false,
    };

    function closeDialog(newValue: boolean) {
      isError.value = false;
      errorMessage.value = "";
      emit("close-dialog", newValue);
    }

    async function requestNode() {
      isError.value = false;
      isLiveStats.value = false;
      errorLoadingStatsMessage.value = undefined;
      nodeOptions.loadStats = true;

      if (props.nodeId > 0) {
        try {
          loading.value = true;
          if (props.filterOptions.gpu) {
            nodeOptions.loadGpu = true;
          }
          const _node: GridNode = await getNode(props.nodeId, nodeOptions);
          node.value = _node;
          isLiveStats.value = true;
          const query = { ...router.currentRoute.value.query, nodeId: node.value.nodeId };
          router.replace({ query });
        } catch (_) {
          isLiveStats.value = false;
          errorLoadingStatsMessage.value =
            "The node appears like it's up but it is physically down maybe because it's gone to offline mode.";
          nodeOptions.loadStats = false;
          nodeOptions.loadGpu = false;
          try {
            const _node: GridNode = await getNode(props.nodeId, nodeOptions);
            node.value = _node;
            const query = { ...router.currentRoute.value.query, nodeId: node.value.nodeId };
            router.replace({ query });
          } catch (err: any) {
            isError.value = true;
            errorMessage.value = `Failed to load node with ID ${props.nodeId} due ${err.message}. The node might be offline or unresponsive. You can try requesting it again.`;
          }
        } finally {
          loading.value = false;
        }
      }
    }

    watch(() => props.nodeId, requestNode);

    watch(
      () => props.openDialog,
      newValue => {
        dialog.value = newValue as boolean;
      },
    );

    return {
      NodeStatus,

      dialog,
      node,
      loading,
      isError,
      errorMessage,
      isLiveStats,
      errorLoadingStatsMessage,
      nodeOptions,
      hasActiveProfile,
      requestNode,
      closeDialog,
      getNodeStatusColor,
    };
  },
};
</script>

<style scoped>
.v-list-item__prepend > .v-icon,
.v-list-item__append > .v-icon {
  opacity: 1 !important;
}
:deep(.v-toolbar__content) {
  justify-content: end !important;
  height: 48px !important;
}
</style>
